generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String           @id @default(cuid())
  email           String           @unique
  name            String?
  avatar          String?
  password        String?
  tier            UserTier         @default(MEMBER)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  purchasedSpins  Int              @default(0)
  apiKeys         ApiKey[]
  luckyWheelSpins LuckyWheelSpin[]
  orders          Order[]
  tickets         Ticket[]
  transactions    Transaction[]
  wallet          Wallet?

  @@index([email])
  @@map("users")
}

model Wallet {
  id           String   @id @default(cuid())
  userId       String   @unique
  balance      Decimal  @default(0) @db.Decimal(15, 2)
  totalDeposit Decimal  @default(0) @db.Decimal(15, 2)
  totalSpent   Decimal  @default(0) @db.Decimal(15, 2)
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("wallets")
}

model ServiceCategory {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  icon        String
  color       String
  description String?
  isActive    Boolean   @default(true)
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  services    Service[]

  @@map("service_categories")
}

model Service {
  id           String          @id @default(cuid())
  categoryId   String
  name         String
  slug         String          @unique
  type         ServiceType
  description  String
  instructions String?
  isActive     Boolean         @default(true)
  order        Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  orders       Order[]
  faqs         ServiceFAQ[]
  servers      ServiceServer[]
  category     ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([slug])
  @@map("services")
}

model ServiceServer {
  id                String   @id @default(cuid())
  serviceId         String
  name              String
  price             Decimal  @db.Decimal(10, 2)
  minQuantity       Int
  maxQuantity       Int
  estimatedTime     String
  speed             String
  quality           String
  tags              String[] @default([])
  isRecommended     Boolean  @default(false)
  isActive          Boolean  @default(true)
  providerKey       String?
  providerServiceId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  orders            Order[]
  service           Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@map("service_servers")
}

model ServiceFAQ {
  id        String  @id @default(cuid())
  serviceId String
  question  String
  answer    String
  order     Int     @default(0)
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("service_faqs")
}

model Order {
  id              String        @id @default(cuid())
  orderId         String        @unique
  userId          String
  serviceId       String
  serverId        String
  link            String
  quantity        Int
  totalPrice      Decimal       @db.Decimal(15, 2)
  status          OrderStatus   @default(PENDING)
  providerOrderId String?
  startCount      Int?
  remainQuantity  Int?
  note            String?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  completedAt     DateTime?
  server          ServiceServer @relation(fields: [serverId], references: [id])
  service         Service       @relation(fields: [serviceId], references: [id])
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([orderId])
  @@index([createdAt(sort: Desc)])
  @@map("orders")
}

model Transaction {
  id            String            @id @default(cuid())
  transactionId String            @unique
  userId        String
  type          TransactionType
  amount        Decimal           @db.Decimal(15, 2)
  balanceAfter  Decimal           @db.Decimal(15, 2)
  description   String
  paymentMethod PaymentMethod?
  status        TransactionStatus @default(PENDING)
  metadata      Json?
  createdAt     DateTime          @default(now())
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt(sort: Desc)])
  @@map("transactions")
}

model Ticket {
  id        String         @id @default(cuid())
  ticketId  String         @unique
  userId    String
  subject   String
  message   String
  status    TicketStatus   @default(OPEN)
  priority  TicketPriority @default(MEDIUM)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  replies   TicketReply[]
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("tickets")
}

model TicketReply {
  id        String   @id @default(cuid())
  ticketId  String
  userId    String
  isAdmin   Boolean  @default(false)
  message   String
  createdAt DateTime @default(now())
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_replies")
}

model ApiKey {
  id        String    @id @default(cuid())
  userId    String
  key       String    @unique
  name      String
  isActive  Boolean   @default(true)
  lastUsed  DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([key])
  @@map("api_keys")
}

model SMMProvider {
  id          String    @id @default(cuid())
  name        String
  apiUrl      String
  apiKey      String
  isActive    Boolean   @default(true)
  balance     Decimal?  @db.Decimal(15, 2)
  lastChecked DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("smm_providers")
}

model Announcement {
  id        String   @id @default(cuid())
  title     String
  content   String
  author    String
  isPinned  Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("announcements")
}

model LuckyWheelSpin {
  id        String   @id @default(cuid())
  userId    String
  prize     String
  amount    Decimal  @db.Decimal(15, 2)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("lucky_wheel_spins")
}

model LuckyWheelConfig {
  id          String   @id @default(cuid())
  prizes      Json
  spinsPerDay Int      @default(3)
  spinCost    Decimal  @default(0) @db.Decimal(10, 2)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("lucky_wheel_config")
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

enum UserTier {
  ADMIN
  MEMBER
  VIP
  RESELLER
  AGENCY
}

enum ServiceType {
  LIKE
  FOLLOW
  COMMENT
  SHARE
  VIEW
  SUBSCRIBER
  REACTION
}

enum OrderStatus {
  PENDING
  PROCESSING
  IN_PROGRESS
  COMPLETED
  PARTIAL
  CANCELLED
  REFUNDED
}

enum TransactionType {
  DEPOSIT
  ORDER
  REFUND
  BONUS
  WITHDRAWAL
  MANUAL
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  MOMO
  ZALOPAY
  CARD
  CRYPTO
}

enum TicketStatus {
  OPEN
  PENDING
  REPLIED
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
